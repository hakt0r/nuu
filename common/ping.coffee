###

  * c) 2007-2018 Sebastian Glaser <anx@ulzq.de>
  * c) 2007-2018 flyc0r

  This file is part of NUU.

  NUU is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  NUU is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with NUU.  If not, see <http://www.gnu.org/licenses/>.

                 .  .,:cddxddoddxxkO0KKOo,'...
             .ll:xxxkKXXXKKKKKXXXXXXXXXNNXKK0Oxc'.
              'OKK0kkOxO0O0K0occdOokxx:dO0KKKKK00Od;,
             .cOKKx:..o00x0X0l:;;;lKx,.. .o0KKOkldOOddl,
            ,KK0x, .c:xKKKXKdcd0;..'dKk:.;cxXXX0ocox:dkko.
           lK0KO' .l0XXXXNNX0Kkc',. ,OKX0KXNNXNNNNXO,.,l00d;.
          ;KXKX, 'OXXXOOKkkO,;dOll'.o;lKNXNWWNWNNNNNNk. ;OK0d
         .xKXXk.,OXXX0OccdlldKK0Kl'.:loO0OkK0oll,;kXXX0' .ldKo
        .ldOXk:.okk0xl,.  .cOKXXK0dooc;'.  ..   .,cOKXXO,   ;ol.
        :dxkO;.cKl.kk;lc:...cOK0Odcl::cc;::::lllodoclo0X0x'.;kOc
        l0K0o..OX0.'dd:oo;;;;:x0kkxodkkkkkxx;;,xl::,,,lKXXx;x0XO;
        oXKKd ,0XK; .;;;ooco,...,'.. .,,'. .,'.;:,::.;;:OXX0c.,dd.
        oXXKd.,OXKd. .,lx0xoo:;c,....  .'',codk00O00OokdOXKXKcloo.
        lKXx. .d00x,.  ..cxxk0KXNNNNK0l;;.,0XNNNWWWNK0kxk0kdXOO00:
        o0Ko  lKXKOoooxxx0XXXXKXXNNXXKx',:lO0kd:;,'.     ':dXXKXNo
        :0Od. 'KXXKk:dx:'........;cd0KKOd;,dd.  .'',,;::. ,0KXKKX;
         lXKk..oXX0:... ,;'';::;.   .:okoxOx.   .,,,c::cc.c0X0lxk.
         'XXX0Olkx,.;;......  ..;.     xKXXc   .,c:;loxkxx0KKc .'d0K0kOkkdoc'.
         .OXXN0. . ,KNNNX0xc'',;:,.'.. ;XWN0kxdc;,,;coKNNXO:.    ;NWWWWWWWWWWWNO
          .kXXXk. .oKXXKXNWNK0kkOKKKOl  kNWO;dO0XNNNNNX0xo.      'NWNNNNNNNNNNKX
            :x0Kx. .,cc;:xXNNNWWWNXO'   lXWNKl..:x0KKK0doc       .ONXXNNNNXKXXk,
           ;lxkod:       .lOKXXXNXXd .,.:KXXXK0O;  .':xxdOo. .   'KNXdKNNNNNNNNd
        'l0XXXK, ,. .. ';. .lO0Oo:. .,.  ....'..,ll,.   ..'. .. .kXKd  '..,xO0Oc
      ,ONNNNNNx. ';. ..'.   ,;'.  'o:....    .,kKNXNXXkc.       ;XNN0..0o  ,0XX'
    ,kNWNNXXXXOc..ol;'..::,.    .lkOKXXKKkd;'dKKXNX0Okdloxc.   .ONNNX, kNd  cKNO
  .kWWWN0l'.:kXXK:'x;..:;,....'xNXKKK0OOoo,;..:,,,.   ...cO:   cXNWNX' 'XNl  'oX
.dNWWNx;     oNWNX:.'. .:,..;:kXd;o:.    ',;c;'dOKKdodo:lxO;  .OXNWWN,  oWX:   .
NWWNx:   ..  dWWWN0'.oc.::::,,l0dd:...:okKXXK0xO0NNXOkKxc'   ',OXNNWWk  .OW0.
Kx0o   'OXk..xNNXo,xl'l,'lx:,c,OXo;0k0kOO0kcld0x:;:lOO;... .lKx0XXKO0Nc  :NNx. .
. .l:  ;kKKk0XOc. 'OXo,d:..'.,odxoocxl.OKk. ..ccko,,.o'   lKX0KKKK:  ,k,  xN0,
oc,.'o:. ,0Ko,  .xXloXl.dOc.  ...:ld;;oxlkckOkkddNKK00ddkKNWK'.:0d  ,lKXc '0NO:
XXKK00Kx. ..', .;0X' cXc.xNN0x:.   .'',cd0XXNXXXKkd:..oXNWNWWd  ;;.cKNWWXl.lXKd.
X0xx0XOd.   ,kO0XWWd  c0d.cKNNNNKkc;..  .c0x,;,.       .oXWWWXl  lKo..dXNXkx0Kx.
oNWXKX0:.     ckKNWX; .kXl .c0XKKXXXXXX00Xx              .kWWXc  cXXl  .xKXOx0K:
 ,l0KOdxOo. .   ,0NNO. ,0Kc   ,lco0XNNWWWx.ld:... . .'. ...cKk'  'KNNl    . .kK0
kxl. .cOXXO..;,  .0WNl  .00k;'l:oXNKXNNNc,xX00Kl   ,:l; '0OOKK:   oNNXl    ,ldkK
KWW0.  .kNNk cO;  ;NWN,  xWWW00X::NxkXNo.0XNOOXX' ,;dO:  OWWWWNd. dKXN0.   lk0lo

                                                       David L. Mills * 6/3/1938
                                   designer of NTP, inernet pioneer, hero of man
###

$static class SyncPing
  constructor:->
    @timer     = null
    @ringId    = -1
    @ringBf    = []
    @bestPing  = [0,0,0]
    @bestDelta = [0,0,0]
    @avrgDelta = @avrgPing = @pings = 0

SyncPing::add = (id,remote)->
  local  = Date.now()
  prediction = local - @avrgDelta
  error  = remote - prediction
  ping   = .5 * ( local - @ringBf[id] ) # this assumption is ofc wrong :D
  delta  = local - ping - remote
  return false if @bestPing[0] < ping if 1 is ++@pings
  @bestPing[2]  = @bestPing[1];  @bestPing[1]  = @bestPing[0];  @bestPing[0]  = ping
  @bestDelta[2] = @bestDelta[1]; @bestDelta[1] = @bestDelta[0]; @bestDelta[0] = delta
  if 2 < @pings
    @avrgPing = @bestPing[0]
    @avrgDel = @bestDelta[0]
  else
    @avrgDelta = ( @bestPing[0]  + @bestPing[1]  + @bestPing[2]  ) / 3
    @avrgPing  = ( @bestDelta[0] + @bestDelta[1] + @bestDelta[2] ) / 3
  return true unless 20 < ++@pings and 1.33 > @avrgDelta
  # assume that system clocks are sync; TODO: track clock-skew again
  NUU.time = Date.now
  SyncPing::add = ->
  true

SyncPing::engage = -> => @timer = $interval 1000, =>
  @ringBf[id = ++@ringId % 32] = Date.now()
  msg = Buffer.from [NET.pingCode,id]
  NET.send msg.toString 'binary'

SyncPing::disengage = -> => clearInterval @timer

return if isServer

$static 'Ping', new SyncPing
NUU.time = -> Date.now() - Ping.avrgDelta
NUU.on 'connect',    do Ping.engage
NUU.on 'disconnect', do Ping.disengage
