console.log """\n#######################################################################################
#### NUU ### 0.4.72 ### Gordon Cooper - Astronaut - * 3/6/1927 † 10/4/2004 ############
#######################################################################################

                       ░░░░█░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██
                  ▒ ▒▒░▒▒██ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ░     ░██ ▒▒▒▒▒▒▒▒▒▒██░
                 ▒ ▒▒  ██▒▒▒▒▒▒▒▒▒▒ ░      ▒░ ░ ░░░░ ░ ▒▒▒▒▒▒▒ ████
                ▒ ██▒▒▒▒▒▒░█░     ▒▒▒▒▒░░▒░      ░ ░░ ░░▓▓█▓▓██▓████
                ██▒▒▒▒▒░▓██        ▒▒▒░░░░░ ░▒░░░░   ░░░░ ▓▓████████░
            ░ ██▒▒▒ ▒████░░░     ▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░▒░░█████████
            ░█▒ ▒▒▒░█████░░        ▒▒▒▒▒░▒░░░░░ ░░░░░░░▒ ▒▒▒█▓███████░
         ░▓▒▒▒▒ ░█████░░░░░      ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█ ░▒▒ ▓▓▓▓▓▓████░
        ██▒▒▒▒░▓▓████░░░░░       ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒▒░▒▒▒▓██▓▓█████
       █▓░░▓▓▓███████░░░░      ▒ ▒▒▒▒▒█░░     ▒▒▒░  ▒▒▒░░░░░   ▓█▓██████░
      ░█ ▓▓▓▓▓▓████░░█░░░ ░     ░░     ░░░░░   ▒▒░░░ ▒▒▒░░░░▒ ▒█▓████████
    ░░█▓▒▒  ▒▓█████░█░░░░░ ░░    ░░ ▒▒░█  ░   ▒   ▒▒▒▒░      ░░ █▓█████████
     ░█ ▒▒▒  ▒██████░░░░░        ░ ▒▒▒▒▒░▒   ▒▒  ▒▒▒▒▒▒░      ░▒░██▓███████░
      ▓▒ ░▒▒▒▒▒ ███░░             ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ▒▒▒▒▒▒░     ░░███████░███
    ▒ █ ▒▒░▒▒▒▒▒▒██░░            ▒▒▒▒▒▒▒░▒▒▒▒▒▒▒ ▒▒▒ ▒▒▒▒▒░ ░░░░░███████ ░███▒
    ▒▒ █ ▒▒▒▒ ▒▒ ▒░█░      ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒    ▒▒       ░░▒▒░░░██░████░▒██
    ▒▒▒█▒ ▒▒ ░░ ▒▒▒░█░      ▒  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒       ░  ▒▒░ ░░▒▒░░████░░ ░ █
    ▒▒▒ ▓  ▒ ███ ░▒▒░█░░       ▒▒▒▒▒▒▒▒▒ ▒▒▒▒▒ ▒▒  ░    ▒░ ▒░░  ░▒░███░█░ ░▒█░
    ▒▒▒▒▒▓▒ ▒▒█░█  ▒▒▒██░          ▒▒  ▒▒▒▒▒▒  ▒▒▒     ▒▒░░░░▒▒▒▒░ ░░▒███▓░░░
     ░▒▒▒▒▒█▒▒▒▒▒▒▒░  ▒▓█░░             ▒▒ ▒▒▒▒▒ ▒▒   ▒░░ ▒▒░▒▒░ ░█▒█░░░░
      ░▒▒▒░▒▒▒ █▓▓▓░█ ░ ██░           ▒   ▒ ▒  ▒ ▒▒  ░░   ▒▒▒░░ ░░▒██░▒
        ░▒▒▒▒▒▒ ▓▓▓▓▓▓░░▓██░ ░░            ▒▒      ██░ ▒▒▒▒▒▒▒▒  ██▒░
          ▒▒▒▒░▒▒ █▓█▓▓▓▓▓███▓██▓▓▓██▓▓▓▓▓▓█░ ░░░░ ▒      ░░███▒▒░░░
               ▒▒▒▒▒▒▒░░▒▒▒░▒░█▓▓█▒▒░▒▒▒▒▒▒▒▒▒▒▒ ▒▒▒▒▒░░░░░▒▒░░░▒▒
                  ░▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░

#######################################################################################

    * c) 2007-2018 Sebastian Glaser <anx@ulzq.de>
    * c) 2007-2008 flyc0r

    The nuu project intends to use all the asset files according to
    their respective licenses.

    nuu currently uses the graphics and sound assets of the excellent
    naev project, which in turn are partly attributable to the
    Vega Strike project.

    All assets are downloaded from their source repo to the contrib
    folder during the build process and LICENSE information is copied
    to the build directory as well as being made available in the
    client's about screen and the server splash.

    for more information see:
      build/ARTWORK_LICENSE.txt
      build/SOUND_LICENSE.txt

#######################################################################################"""

fs = require 'fs'

global.$static   = (name,value) -> global[name] = value
$static.list     = global
global.$library  = (args...) -> for a in args
  if Array.isArray a then global[a[0]] = require a[1] else global[a] = require a
global.$public   = (args...) -> global[a.name] = a for a in args
global.$cue      = (f) -> setImmediate f

$static 'debug',    no
$static 'isClient', no
$static 'isServer', yes

$static 'NET', {}
$static 'NUU', {}

## Load sources
deps =
  common : JSON.parse fs.readFileSync './common/build.json'
  client : JSON.parse fs.readFileSync './client/build.json'
  server : JSON.parse fs.readFileSync './server/build.json'

for lib in deps.server.require
  if Array.isArray lib
    if lib.length is 3
      $static lib[0], require(lib[1])[lib[2]]
    else $static lib[0], require(lib[1])
  else $static lib, require lib

for lib in deps.common
  require '../build/common/' + lib

NUU.deps = deps

for lib in deps.server.sources
  require '../build/server/' + lib + '.js' if lib isnt 'server'

## Initialize express / setup WebSockets
$websocket NUU.web = express()
## Setup Webserver
NUU.web.use require('morgan')() if debug
# NUU.web.use require('body-parser') keepExtensions: true, uploadDir: '/tmp/'
NUU.web.use require('compression')()
NUU.web.use require('cookie-parser')()
NUU.web.use require('express-session') secret: 'what-da-nuu', saveUninitialized:no, resave:no
NUU.web.use '/build', require('serve-static')('build',etag:no)
NUU.web.use '/build', require('serve-index' )('build',etag:no)
NUU.web.get '/',      NUU.splashPage false
NUU.web.get '/intro', NUU.splashPage true
NUU.web.get '/start', NUU.startPage()

## Initialize Engine
console.log ':nuu', 'initializing'.yellow
NUU.init()

NUU.chgid  = process.env.CHGID || false
NUU.port   = process.env.PORT  || 9999
NUU.addr   = process.env.ADDR  || '127.0.0.1'

NUU.lockPath = '/tmp/nuu.lock.' + ( NUU.chgid || process.getuid() )

if fs.existsSync NUU.lockPath
  pid = parseInt fs.readFileSync NUU.lockPath, 'utf8'
  cp = require 'child_process'
  try
    cp.execSync "while fuser -k #{NUU.lockPath}; do :; done >/dev/null 2>&1"
    console.log 'lock', 'killed'.green, pid.toString().red
  catch
    console.log ':nuu', 'stale lockfile', pid
fs.writeFileSync NUU.lockPath, process.pid
fs.open NUU.lockPath, 0, ->

$static '$release', JSON.parse fs.readFileSync './build/release.json'
$release.banner = $release.v.green + $release.git.red

console.log 'http', 'listen'.yellow, NUU.addr.red + ':' + NUU.port.toString().magenta
NUU.web.listen NUU.port, NUU.addr, ->
  console.log 'http', 'online'.green, NUU.addr.red + ':' + NUU.port.toString().magenta
  console.log ':nuu', $release.banner
  if NUU.chgid
    console.log 'http', 'dropping privileges'.green
    process.setgid NUU.chgid
    process.setuid NUU.chgid
  null
